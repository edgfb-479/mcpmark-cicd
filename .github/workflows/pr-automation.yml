name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  code-quality:
    name: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: |
          echo "Running ESLint checks..."
          npm run lint > eslint-results.txt 2>&1 || echo "ESLINT_FAILED=true" >> $GITHUB_OUTPUT
          cat eslint-results.txt

      - name: Check Prettier formatting
        id: prettier
        run: |
          echo "Running Prettier format check..."
          npx prettier --check src/ > prettier-results.txt 2>&1 || echo "PRETTIER_FAILED=true" >> $GITHUB_OUTPUT
          cat prettier-results.txt

      - name: Generate Code Quality Report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let eslintResults = '';
            let prettierResults = '';
            
            try {
              eslintResults = fs.readFileSync('eslint-results.txt', 'utf8');
            } catch (e) {
              eslintResults = 'ESLint results not available';
            }
            
            try {
              prettierResults = fs.readFileSync('prettier-results.txt', 'utf8');
            } catch (e) {
              prettierResults = 'Prettier results not available';
            }
            
            const eslintPassed = !core.getInput('ESLINT_FAILED', { required: false });
            const prettierPassed = !core.getInput('PRETTIER_FAILED', { required: false });
            
            const statusIcon = (passed) => passed ? '✅' : '❌';
            
            const commentBody = `## Code Quality Report
n            
            ### Summary
            - ${statusIcon(eslintPassed)} **ESLint**: ${eslintPassed ? 'Passed' : 'Failed'}
            - ${statusIcon(prettierPassed)} **Prettier**: ${prettierPassed ? 'Passed' : 'Failed'}
            
            ### Details
            
            #### ESLint Results
            \`\`\`bash
            ${eslintResults}
            \`\`\`
            
            #### Prettier Results
            \`\`\`bash
            ${prettierResults}
            \`\`\`
            
            ---
            *Generated by PR Automation Workflow*`.replace(/core.getInput/g, 'process.env');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  testing-suite:
    name: testing-suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: tests
        run: |
          echo "Running test suite with coverage..."
          npm run test:coverage > test-results.txt 2>&1 || echo "TESTS_FAILED=true" >> $GITHUB_OUTPUT
          cat test-results.txt

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/
            test-results.txt
          retention-days: 7

      - name: Generate Test Coverage Report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let testResults = '';
            let coverageSummary = '';
            
            try {
              testResults = fs.readFileSync('test-results.txt', 'utf8');
            } catch (e) {
              testResults = 'Test results not available';
            }
            
            try {
              const coverageFile = 'coverage/coverage-summary.json';
              if (fs.existsSync(coverageFile)) {
                const coverageData = JSON.parse(fs.readFileSync(coverageFile, 'utf8'));
                const total = coverageData.total;
                coverageSummary = `\n**Coverage Summary:**
                - Statements: ${total.statements.pct}%
                - Branches: ${total.branches.pct}%
                - Functions: ${total.functions.pct}%
                - Lines: ${total.lines.pct}%`;
              } else {
                coverageSummary = '\nCoverage summary not available';
              }
            } catch (e) {
              coverageSummary = '\nError reading coverage data';
            }
            
            const testsPassed = !process.env.TESTS_FAILED;
            const statusIcon = testsPassed ? '✅' : '❌';
            
            const commentBody = `## Test Coverage Report
            
            ### Summary
            ${statusIcon} **Tests**: ${testsPassed ? 'All tests passed' : 'Some tests failed'}${coverageSummary}
            
            ### Test Results
            \`\`\`bash
            ${testResults}
            \`\`\`
            
            ${testsPassed ? '' : '⚠️ Please review the failing tests above.'}
            
            ---
            *Generated by PR Automation Workflow*`.replace(/process.env/g, 'process.env');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  security-scan:
    name: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for dependency vulnerabilities
        id: audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate > audit-results.txt 2>&1 || echo "AUDIT_FAILED=true" >> $GITHUB_OUTPUT
          cat audit-results.txt

      - name: Scan for secrets in code changes
        id: secrets
        run: |
          echo "Scanning for potential secrets..."
          # Basic secret pattern scanning
          if git diff --name-only HEAD~1..HEAD 2>/dev/null; then
            git diff HEAD~1..HEAD | grep -i -E '(password|secret|key|token|api[_-]?key|auth)' > secret-scan.txt 2>&1 || true
          else
            # For initial PRs without history
            find src/ -type f -name "*.js" -exec grep -i -H -n -E '(password|secret|key|token|api[_-]?key|auth)' {} \; > secret-scan.txt 2>&1 || true
          fi
          
          if [ -s secret-scan.txt ]; then
            echo "Potential secrets found!" | tee -a secret-scan.txt
            echo "SECRETS_FOUND=true" >> $GITHUB_OUTPUT
          else
            echo "No secrets detected" > secret-scan.txt
          fi
          cat secret-scan.txt

      - name: Generate Security Scan Report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let auditResults = '';
            let secretScanResults = '';
            
            try {
              auditResults = fs.readFileSync('audit-results.txt', 'utf8');
            } catch (e) {
              auditResults = 'Audit results not available';
            }
            
            try {
              secretScanResults = fs.readFileSync('secret-scan.txt', 'utf8');
            } catch (e) {
              secretScanResults = 'Secret scan results not available';
            }
            
            const auditPassed = !process.env.AUDIT_FAILED;
            const secretsFound = process.env.SECRETS_FOUND === 'true';
            
            const statusIcon = (passed) => passed ? '✅' : '❌';
            const warningIcon = '⚠️';
            
            const commentBody = `## Security Scan Report
            
            ### Summary
            - ${statusIcon(auditPassed)} **Dependencies**: ${auditPassed ? 'No vulnerabilities found' : 'Vulnerabilities detected'}
            - ${secretsFound ? warningIcon : '✅'} **Secrets**: ${secretsFound ? 'Potential secrets found' : 'No secrets detected'}
            
            ### Vulnerabilities
            \`\`\`bash
            ${auditResults}
            \`\`\`
            
            ### Secret Scan Results
            \`\`\`bash
            ${secretScanResults}
            \`\`\`
            
            ${!auditPassed ? '⚠️ **Action Required**: Please review and fix the dependency vulnerabilities above.' : ''}
            ${secretsFound ? '⚠️ **Warning**: Potential secrets detected in code changes. Please review and remove any sensitive information.' : ''}
            
            ---
            *Generated by PR Automation Workflow*`.replace(/process.env/g, 'process.env');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  build-validation:
    name: build-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: |
          echo "Building application..."
          npm run build > build-results.txt 2>&1 || echo "BUILD_FAILED=true" >> $GITHUB_OUTPUT
          cat build-results.txt

      - name: Start application for validation
        if: success()
        id: start-app
        run: |
          echo "Starting application for endpoint validation..."
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # Wait for app to start
          sleep 5
          
          # Check if app is running
          if ps -p $APP_PID > /dev/null; then
            echo "Application started successfully"
            echo "APP_RUNNING=true" >> $GITHUB_OUTPUT
          else
            echo "Application failed to start"
            echo "APP_RUNNING=false" >> $GITHUB_OUTPUT
            echo "START_FAILED=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate endpoints
        if: steps.start-app.outputs.APP_RUNNING == 'true'
        id: validate
        run: |
          echo "Validating endpoints..."
          
          # Test health endpoint
          if curl -f -s http://localhost:3000/health > /dev/null; then
            echo "✅ Health endpoint is accessible"
            echo "HEALTH_CHECK=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Health endpoint is not accessible"
            echo "HEALTH_CHECK=false" >> $GITHUB_OUTPUT
          fi
          
          # Test main endpoint
          if curl -f -s http://localhost:3000/ > /dev/null; then
            echo "✅ Main endpoint is accessible"
            echo "MAIN_ENDPOINT=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Main endpoint is not accessible"
            echo "MAIN_ENDPOINT=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop application
        if: always() && env.APP_PID
        run: |
          echo "Stopping application..."
          kill $APP_PID 2>/dev/null || true
          sleep 2

      - name: Create deployment preview artifacts
        if: success()
        run: |
          echo "Creating deployment preview..."
          mkdir -p deployment-preview
          echo "# Deployment Preview" > deployment-preview/README.md
          echo "Generated on: $(date)" >> deployment-preview/README.md
          echo "Commit: ${{ github.sha }}" >> deployment-preview/README.md
          echo "PR: #${{ github.event.pull_request.number }}" >> deployment-preview/README.md
          echo "" >> deployment-preview/README.md
          echo "## Endpoints" >> deployment-preview/README.md
          echo "- Health: http://localhost:3000/health" >> deployment-preview/README.md
          echo "- Main: http://localhost:3000/" >> deployment-preview/README.md

      - name: Upload deployment preview artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-preview
          path: deployment-preview/
          retention-days: 7

      - name: Generate Build Validation Report
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let buildResults = '';
            
            try {
              buildResults = fs.readFileSync('build-results.txt', 'utf8');
            } catch (e) {
              buildResults = 'Build results not available';
            }
            
            const buildPassed = !process.env.BUILD_FAILED;
            const startPassed = !process.env.START_FAILED;
            const healthCheck = process.env.HEALTH_CHECK === 'true';
            const mainEndpoint = process.env.MAIN_ENDPOINT === 'true';
            
            const statusIcon = (passed) => passed ? '✅' : '❌';
            
            const commentBody = `## Build Validation
            
            ### Summary
            - ${statusIcon(buildPassed)} **Build**: ${buildPassed ? 'Successful' : 'Failed'}
            - ${statusIcon(startPassed)} **Application Start**: ${startPassed ? 'Successful' : 'Failed'}
            - ${statusIcon(healthCheck)} **Health Endpoint**: ${healthCheck ? 'Accessible' : 'Not accessible'}
            - ${statusIcon(mainEndpoint)} **Main Endpoint**: ${mainEndpoint ? 'Accessible' : 'Not accessible'}
            
            ### Build Output
            \`\`\`bash
            ${buildResults}
            \`\`\`
            
            ${buildPassed && startPassed && healthCheck && mainEndpoint ? '✅ All build validation checks passed!' : '⚠️ Some build validation checks failed. Please review the output above.'}
            
            ---
            *Generated by PR Automation Workflow*`.replace(/process.env/g, 'process.env');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  # Summary job that runs after all parallel jobs
  workflow-summary:
    name: workflow-summary
    needs: [code-quality, testing-suite, security-scan, build-validation]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Workflow Summary
        uses: actions/github-script@v7
        with:
          script: |
            const codeQuality = '${{ needs.code-quality.result }}';
            const testingSuite = '${{ needs.testing-suite.result }}';
            const securityScan = '${{ needs.security-scan.result }}';
            const buildValidation = '${{ needs.build-validation.result }}';
            
            const statusIcon = (status) => {
              switch(status) {
                case 'success': return '✅';
                case 'failure': return '❌';
                case 'cancelled': return '⏹️';
                default: return '⚠️';
              }
            };
            
            const allPassed = codeQuality === 'success' && 
                             testingSuite === 'success' && 
                             securityScan === 'success' && 
                             buildValidation === 'success';
            
            const summaryBody = `## Pull Request Automation Summary
            
            ### Workflow Results
            - ${statusIcon(codeQuality)} **Code Quality**: ${codeQuality}
            - ${statusIcon(testingSuite)} **Testing Suite**: ${testingSuite}
            - ${statusIcon(securityScan)} **Security Scan**: ${securityScan}
            - ${statusIcon(buildValidation)} **Build Validation**: ${buildValidation}
            
            ### Overall Status
            ${allPassed ? '✅ **All checks passed!** This PR is ready for review.' : '❌ **Some checks failed.** Please review the individual job reports above.'}
            
            ---
            *Workflow completed at ${new Date().toISOString()}*`.replace(/new Date/g, 'Date');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summaryBody
            });